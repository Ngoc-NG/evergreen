
upstream jenkins {
    server localhost:8080;
}

upstream evergreen {
    server localhost:8081;
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    root /var/www/localhost/htdocs;

    error_page 502 /502.html;
    error_page 503 /503.html;
    error_page 521 /521.html;

    # Injecting a /evergreen-static/ route first and foremost to ensure that
    # our pages can reference static assets appropriately.
    location ^~ /evergreen-static/ {
        autoindex on;
        root /var/www/localhost/htdocs/;
    }

    location / {
        if ( -f /evergreen/booting.txt ) {
            # Used by Cloudflare as "Web Server is down"
            #
            # We're using in this case to convey to the end user that the
            # Jenkins environment is booting
            return 521;
        }
        proxy_pass http://jenkins;
    }

    location /evergreen {
        proxy_pass http://evergreen;
    }

    # You may need these to prevent route recursion
    location = /404.html {
        internal;
    }
    # Bad Gateway
    location = /502.html {
        internal;
    }
    # Service Unavailable
    location = /503.html {
        internal;
    }
    # Web Server is Down
    location = /521.html {
        internal;
    }
}

# vim: ft=conf et 
